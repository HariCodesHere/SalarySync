<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salary Increment Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        
</head>
<body>
    <header class="app-header">
        <div class="container header-inner">
            <div class="brand">
                <span class="logo" aria-hidden="true">ðŸ’¼</span>
                <div class="brand-text">
                    <h1 class="app-title">SalarySync</h1>
                    <p class="subtitle">Salary Increment Calculator</p>
                </div>
            </div>
            <div class="header-actions">
                <a class="btn btn-primary" href="header.xlsx" download>
                    Download header.xlsx
                </a>
            </div>
        </div>
    </header>
    <!-- Secure Sharing (Supabase) -->
    <div id="secureSharing" style="background:#1e1e1e;padding:12px;border-radius:8px;margin:12px 0;">
        <h2>Secure Sharing</h2>
        <div id="authBox">
            <input type="text" id="authEmail" placeholder="email" style="max-width:260px;">
            <input type="password" id="authPassword" placeholder="password" style="max-width:260px;">
            <button id="btnSignUp">Sign Up</button>
            <button id="btnSignIn">Sign In</button>
            <button id="btnSignOut" style="display:none;">Sign Out</button>
            <div id="authMsg" class="error"></div>
        </div>
        <div id="shareArea" style="display:none;margin-top:8px;">
            <input type="file" id="sharedFile" accept=".xlsx,.xls">
            <button id="btnUploadShared">Upload to Shared</button>
            <div id="uploadMsg" class="error"></div>
            <div id="adminArea" style="display:none;margin-top:8px;">
                <button id="btnListFiles">Refresh Files</button>
                <div id="filesList" style="margin-top:6px;"></div>
            </div>
        </div>
    </div>
    
    <!-- Step 1: File Upload -->
    <div id="step1" class="step active">
        <h2>Step 1: Upload Excel File</h2>
        <input type="file" id="fileInput" accept=".xlsx,.xls">
        <button id="uploadBtn">Upload</button>
        <div id="fileError" class="error"></div>
    </div>
    
    <!-- Step 2: Location-based Increments -->
    <div id="step2" class="step">
        <h2>Step 2: Set Base Increments</h2>
        
        <div class="radio-group">
            <h3>Increment Method:</h3>
            <div class="radio-option">
                <input type="radio" id="locationBased" name="incrementMethod" value="location" checked>
                <label for="locationBased">Location-based increments</label>
            </div>
            <div class="radio-option">
                <input type="radio" id="uniformIncrement" name="incrementMethod" value="uniform">
                <label for="uniformIncrement">Uniform increment for all</label>
            </div>
        </div>
        
        <div id="locationInputs">
            <!-- Will be populated based on selected method -->
        </div>
        
        <button id="prevBtn2">Previous</button>
        <button id="nextBtn2">Continue</button>
        <div id="locationError" class="error"></div>
    </div>
    
    <!-- Step 3: Rating-based Increments -->
    <div id="step3" class="step">
        <h2>Step 3: Set Rating-based Increments</h2>
        <div id="ratingInputs"></div>
        <button id="prevBtn3">Previous</button>
        <button id="nextBtn3">Continue</button>
        <div id="ratingError" class="error"></div>
    </div>
    
    <!-- Step 4: Department Adjustments -->
    <div id="step4" class="step">
        <h2>Step 4: Department Adjustments</h2>
        <div>
            <label>Total Department Fund: </label>
            <input type="number" id="totalFund" min="0">
        </div>
        <div>
            <h3>Distribution Method:</h3>
            <div class="radio-option">
                <input type="radio" name="distribution" id="evenDist" value="even" checked>
                <label for="evenDist">Even Distribution</label>
            </div>
            <div class="radio-option">
                <input type="radio" name="distribution" id="percentageDist" value="percentage">
                <label for="percentageDist">Percentage Distribution</label>
            </div>
            <div class="radio-option">
                <input type="radio" name="distribution" id="amountDist" value="amount">
                <label for="amountDist">Direct Amount Entry</label>
            </div>
        </div>
        
        <div id="distributionInputs"></div>
        <button id="prevBtn4">Previous</button>
        <button id="nextBtn4">Continue</button>
        <div id="hodError" class="error"></div>
    </div>
    
    <!-- Step 5: Review and Download -->
    <div id="step5" class="step">
        <h2>Step 5: Review and Download</h2>
        <div id="previewTable"></div>
        <button id="prevBtn5">Previous</button>
        <button id="downloadBtn">Download Updated File</button>
    </div>

    <script>
        // Global variables
        let workbook;
        let worksheet;
        let jsonData;
        let uniqueLocations = [];
        let uniqueRatings = [];
        let totalFund = 0;
        
        // DOM elements
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const steps = document.querySelectorAll('.step');
        const locationInputs = document.getElementById('locationInputs');
        const ratingInputs = document.getElementById('ratingInputs');
        const distributionInputs = document.getElementById('distributionInputs');
        const previewTable = document.getElementById('previewTable');
        
        // Navigation functions
        function showStep(stepNumber) {
            steps.forEach((step, index) => {
                step.classList.toggle('active', index === stepNumber - 1);
            });
        }
        
        // Step 1: File Upload
        uploadBtn.addEventListener('click', () => {
            const file = fileInput.files[0];
            if (!file) {
                document.getElementById('fileError').textContent = 'Please select a file';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    workbook = XLSX.read(data, { type: 'array' });
                    worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    // Verify required columns exist
                    const requiredColumns = ['Employee Code', 'Employee Name', 'Location', 'Rating', 'Department', 'Current Salary'];
                    const missingColumns = requiredColumns.filter(col => !jsonData[0]?.hasOwnProperty(col));
                    
                    if (missingColumns.length > 0) {
                        document.getElementById('fileError').textContent = `Missing columns: ${missingColumns.join(', ')}`;
                        return;
                    }
                    
                    // Get unique locations and ratings
                    uniqueLocations = [...new Set(jsonData.map(row => row['Location']))];
                    uniqueRatings = [...new Set(jsonData.map(row => row['Rating']))].filter(r => r);
                    
                    // Proceed to step 2
                    showStep(2);
                    updateIncrementMethodUI();
                } catch (error) {
                    document.getElementById('fileError').textContent = 'Error processing file: ' + error.message;
                }
            };
            reader.readAsArrayBuffer(file);
        });
        
        // Step 2: Base Increments
        function updateIncrementMethodUI() {
            const method = document.querySelector('input[name="incrementMethod"]:checked').value;
            locationInputs.innerHTML = '';
            
            if (method === 'location') {
                uniqueLocations.forEach(location => {
                    const div = document.createElement('div');
                    div.innerHTML = `
                        <label>${location}: </label>
                        <input type="number" class="location-percent" data-location="${location}" min="0" step="0.1">%
                    `;
                    locationInputs.appendChild(div);
                });
            } else if (method === 'uniform') {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label>Uniform Increment Percentage: </label>
                    <input type="number" id="uniformPercent" min="0" step="0.1">%
                `;
                locationInputs.appendChild(div);
            }
        }
        
        // Listen for method changes
        document.querySelectorAll('input[name="incrementMethod"]').forEach(radio => {
            radio.addEventListener('change', updateIncrementMethodUI);
        });
        
        document.getElementById('nextBtn2').addEventListener('click', () => {
            const method = document.querySelector('input[name="incrementMethod"]:checked').value;
            let isValid = true;
            
            if (method === 'location') {
                const locationPercents = {};
                
                document.querySelectorAll('.location-percent').forEach(input => {
                    const location = input.dataset.location;
                    const percent = parseFloat(input.value);
                    
                    if (isNaN(percent)) {
                        isValid = false;
                        document.getElementById('locationError').textContent = 'Please enter valid percentages for all locations';
                        return;
                    }
                    
                    locationPercents[location] = percent;
                });
                
                if (!isValid) return;
                
                // Apply location-based increments
                jsonData.forEach(row => {
                    const percent = locationPercents[row['Location']];
                    row['Base Increment'] = (row['Current Salary'] * percent / 100).toFixed(2);
                });
            } 
            else if (method === 'uniform') {
                const uniformPercent = parseFloat(document.getElementById('uniformPercent').value);
                
                if (isNaN(uniformPercent)) {
                    document.getElementById('locationError').textContent = 'Please enter a valid percentage';
                    return;
                }
                
                // Apply uniform increment to all
                jsonData.forEach(row => {
                    row['Base Increment'] = (row['Current Salary'] * uniformPercent / 100).toFixed(2);
                });
            }
            
            document.getElementById('locationError').textContent = '';
            showStep(3);
            populateRatingInputs();
        });
        
        document.getElementById('prevBtn2').addEventListener('click', () => showStep(1));
        
        // Step 3: Rating-based increments
        function populateRatingInputs() {
            ratingInputs.innerHTML = '';
            uniqueRatings.forEach(rating => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label>Rating ${rating}: </label>
                    <input type="number" class="rating-percent" data-rating="${rating}" min="0" step="0.1">%
                `;
                ratingInputs.appendChild(div);
            });
        }
        
        document.getElementById('nextBtn3').addEventListener('click', () => {
            const ratingPercents = {};
            let isValid = true;
            
            document.querySelectorAll('.rating-percent').forEach(input => {
                const rating = input.dataset.rating;
                const percent = parseFloat(input.value);
                
                if (isNaN(percent)) {
                    isValid = false;
                    document.getElementById('ratingError').textContent = 'Please enter valid percentages for all ratings';
                    return;
                }
                
                ratingPercents[rating] = percent;
            });
            
            if (!isValid) return;
            
            // Apply rating-based increments
            jsonData.forEach(row => {
                if (row['Rating']) {
                    const percent = ratingPercents[row['Rating']];
                    row['Rating Based increment'] = (row['Current Salary'] * percent / 100).toFixed(2);
                }
            });
            
            document.getElementById('ratingError').textContent = '';
            showStep(4);
            populateHodInputs();
        });
        
        document.getElementById('prevBtn3').addEventListener('click', () => showStep(2));
        
        // Step 4: Department Adjustments
        function populateHodInputs() {
            distributionInputs.innerHTML = '';
            document.getElementById('totalFund').value = '';
            
            // Listen for distribution method changes
            document.querySelectorAll('input[name="distribution"]').forEach(radio => {
                radio.addEventListener('change', updateDistributionInputs);
            });
        }
        
        function updateDistributionInputs() {
            const method = document.querySelector('input[name="distribution"]:checked').value;
            distributionInputs.innerHTML = '';
            
            if (method === 'even') {
                // No additional inputs needed for even distribution
            } else if (method === 'percentage') {
                jsonData.forEach((row, index) => {
                    const div = document.createElement('div');
                    div.innerHTML = `
                        <label>${row['Employee Name']} (${row['Employee Code']} - ${row['Department']}): </label>
                        <input type="number" class="employee-percent" data-index="${index}" min="0" max="100" step="0.1">%
                    `;
                    distributionInputs.appendChild(div);
                });
            } else if (method === 'amount') {
                jsonData.forEach((row, index) => {
                    const div = document.createElement('div');
                    div.innerHTML = `
                        <label>${row['Employee Name']} (${row['Employee Code']} - ${row['Department']}): </label>
                        <input type="number" class="employee-amount" data-index="${index}" min="0" step="1">
                    `;
                    distributionInputs.appendChild(div);
                });
            }
        }
        
        document.getElementById('nextBtn4').addEventListener('click', () => {
            totalFund = parseFloat(document.getElementById('totalFund').value);
            
            if (isNaN(totalFund) || totalFund <= 0) {
                document.getElementById('hodError').textContent = 'Please enter a valid total fund amount';
                return;
            }
            
            const method = document.querySelector('input[name="distribution"]:checked').value;
            let allocations = [];
            
            if (method === 'even') {
                const evenAmount = totalFund / jsonData.length;
                allocations = jsonData.map(() => evenAmount);
            } else if (method === 'percentage') {
                let totalPercent = 0;
                allocations = Array(jsonData.length).fill(0);
                
                document.querySelectorAll('.employee-percent').forEach(input => {
                    const index = parseInt(input.dataset.index);
                    const percent = parseFloat(input.value);
                    
                    if (!isNaN(percent)) {
                        allocations[index] = percent;
                        totalPercent += percent;
                    }
                });
                
                if (totalPercent > 100) {
                    document.getElementById('hodError').textContent = 'Total percentage cannot exceed 100%';
                    return;
                }
                
                allocations = allocations.map(p => (totalFund * p / 100));
            } else if (method === 'amount') {
                let totalAmount = 0;
                allocations = Array(jsonData.length).fill(0);
                
                document.querySelectorAll('.employee-amount').forEach(input => {
                    const index = parseInt(input.dataset.index);
                    const amount = parseFloat(input.value);
                    
                    if (!isNaN(amount)) {
                        allocations[index] = amount;
                        totalAmount += amount;
                    }
                });
                
                if (totalAmount > totalFund) {
                    document.getElementById('hodError').textContent = `Total allocated amount (${totalAmount}) exceeds department fund (${totalFund})`;
                    return;
                }
            }
            
            // Apply HOD adjustments
            jsonData.forEach((row, index) => {
                row['HOD Adjustment'] = allocations[index].toFixed(2);
                row['Total Salary'] = (
                    parseFloat(row['Current Salary']) + 
                    parseFloat(row['Base Increment'] || 0) + 
                    parseFloat(row['Rating Based increment'] || 0) + 
                    parseFloat(row['HOD Adjustment'] || 0)
                );
            });
            
            document.getElementById('hodError').textContent = '';
            showStep(5);
            showPreview();
        });
        
        document.getElementById('prevBtn4').addEventListener('click', () => showStep(3));
        
        // Step 5: Review and Download
        function showPreview() {
            const table = document.createElement('table');
            
            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            Object.keys(jsonData[0]).forEach(key => {
                const th = document.createElement('th');
                th.textContent = key;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create body
            const tbody = document.createElement('tbody');
            jsonData.forEach(row => {
                const tr = document.createElement('tr');
                Object.values(row).forEach(value => {
                    const td = document.createElement('td');
                    td.textContent = value;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            
            previewTable.innerHTML = '';
            previewTable.appendChild(table);
        }
        
        document.getElementById('prevBtn5').addEventListener('click', () => showStep(4));
        
        document.getElementById('downloadBtn').addEventListener('click', () => {
            // Convert JSON back to worksheet
            const newWorksheet = XLSX.utils.json_to_sheet(jsonData);
            
            // Update the workbook
            workbook.Sheets[workbook.SheetNames[0]] = newWorksheet;
            
            // Generate Excel file
            const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
            
            // Download
            const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'updated_salaries.xlsx';
            a.click();
            URL.revokeObjectURL(url);
        });

        // ===== Supabase Secure Sharing (config via /api/config) =====
        (async function initSupabaseSharing() {
            try {
                const res = await fetch('/api/config', { cache: 'no-store' });
                if (!res.ok) throw new Error('Failed to load config');
                const cfg = await res.json();

                const SUPABASE_URL = cfg.SUPABASE_URL;
                const SUPABASE_ANON_KEY = cfg.SUPABASE_ANON_KEY;
                const BUCKET = cfg.BUCKET_NAME || 'salarysync';
                const SHARED_PREFIX = cfg.SHARED_PREFIX || 'shared';
                const ADMIN_EMAILS = Array.isArray(cfg.ADMIN_EMAILS) ? cfg.ADMIN_EMAILS : [];

                if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
                    // Surface a gentle notice in the auth box
                    const msg = document.getElementById('authMsg');
                    if (msg) msg.textContent = 'Supabase config missing. Set env vars on Vercel.';
                    return;
                }

                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                // Elements
                const authEmail = document.getElementById('authEmail');
                const authPassword = document.getElementById('authPassword');
                const btnSignUp = document.getElementById('btnSignUp');
                const btnSignIn = document.getElementById('btnSignIn');
                const btnSignOut = document.getElementById('btnSignOut');
                const authMsg = document.getElementById('authMsg');
                const shareArea = document.getElementById('shareArea');
                const adminArea = document.getElementById('adminArea');
                const sharedFile = document.getElementById('sharedFile');
                const btnUploadShared = document.getElementById('btnUploadShared');
                const uploadMsg = document.getElementById('uploadMsg');
                const btnListFiles = document.getElementById('btnListFiles');
                const filesList = document.getElementById('filesList');

                function isAdmin(user) {
                    if (!user) return false;
                    const email = user.email || '';
                    const metaRole = user.user_metadata?.role;
                    return (ADMIN_EMAILS.includes(email)) || (metaRole === 'admin');
                }

                function setAuthState(user) {
                    if (user) {
                        btnSignOut.style.display = 'inline-block';
                        btnSignUp.style.display = 'none';
                        btnSignIn.style.display = 'none';
                        shareArea.style.display = 'block';
                        adminArea.style.display = isAdmin(user) ? 'block' : 'none';
                    } else {
                        btnSignOut.style.display = 'none';
                        btnSignUp.style.display = 'inline-block';
                        btnSignIn.style.display = 'inline-block';
                        shareArea.style.display = 'none';
                        adminArea.style.display = 'none';
                    }
                }

                // Initial session
                const { data: { session } } = await supabase.auth.getSession();
                setAuthState(session?.user || null);

                // Subscribe to auth changes
                supabase.auth.onAuthStateChange((_event, sess) => {
                    setAuthState(sess?.user || null);
                });

                // Auth actions
                btnSignUp.addEventListener('click', async () => {
                    authMsg.textContent = '';
                    const email = authEmail.value.trim();
                    const password = authPassword.value;
                    const { error } = await supabase.auth.signUp({ email, password });
                    authMsg.textContent = error ? error.message : 'Check your inbox to confirm sign up';
                });

                btnSignIn.addEventListener('click', async () => {
                    authMsg.textContent = '';
                    const email = authEmail.value.trim();
                    const password = authPassword.value;
                    const { error } = await supabase.auth.signInWithPassword({ email, password });
                    authMsg.textContent = error ? error.message : 'Signed in';
                });

                btnSignOut.addEventListener('click', async () => {
                    authMsg.textContent = '';
                    await supabase.auth.signOut();
                });

                // Upload shared file
                btnUploadShared.addEventListener('click', async () => {
                    uploadMsg.textContent = '';
                    const file = sharedFile.files?.[0];
                    if (!file) {
                        uploadMsg.textContent = 'Select a file first';
                        return;
                    }

                    const safeName = file.name.replace(/[^a-zA-Z0-9_.-]/g, '_');
                    const objectPath = `${SHARED_PREFIX}/${Date.now()}-${safeName}`;

                    const { error: upErr } = await supabase.storage
                        .from(BUCKET)
                        .upload(objectPath, file, {
                            cacheControl: '3600',
                            upsert: false,
                            contentType: file.type || 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                        });
                    if (upErr) {
                        uploadMsg.textContent = upErr.message;
                        return;
                    }

                    const { data: signed, error: signErr } = await supabase.storage
                        .from(BUCKET)
                        .createSignedUrl(objectPath, 60 * 60);
                    if (signErr) {
                        uploadMsg.textContent = signErr.message;
                        return;
                    }

                    uploadMsg.innerHTML = `Uploaded. <a href="${signed.signedUrl}" target="_blank" rel="noopener">Download (1h)</a>`;
                });

                // Admin: list all shared files
                async function listFiles() {
                    filesList.innerHTML = '';
                    const { data: items, error } = await supabase.storage
                        .from(BUCKET)
                        .list(SHARED_PREFIX, { limit: 100, sortBy: { column: 'created_at', order: 'desc' } });
                    if (error) {
                        filesList.textContent = error.message;
                        return;
                    }
                    if (!items || items.length === 0) {
                        filesList.textContent = 'No files yet';
                        return;
                    }

                    const ul = document.createElement('ul');
                    for (const it of items) {
                        if (!it?.name) continue;
                        const fullPath = `${SHARED_PREFIX}/${it.name}`;
                        const { data: s, error: e2 } = await supabase.storage.from(BUCKET).createSignedUrl(fullPath, 60 * 60);
                        const li = document.createElement('li');
                        if (!e2 && s?.signedUrl) {
                            const a = document.createElement('a');
                            a.href = s.signedUrl;
                            a.textContent = it.name;
                            a.target = '_blank';
                            a.rel = 'noopener';
                            li.appendChild(a);
                        } else {
                            li.textContent = it.name + (e2 ? ` (${e2.message})` : '');
                        }
                        ul.appendChild(li);
                    }
                    filesList.appendChild(ul);
                }

                btnListFiles.addEventListener('click', listFiles);
            } catch (e) {
                const msg = document.getElementById('authMsg');
                if (msg) msg.textContent = 'Sharing init error: ' + e.message;
            }
        })();
    </script>
  </body>
</html>